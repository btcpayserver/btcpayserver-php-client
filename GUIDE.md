## Using the BTCPayServer PHP client

This SDK provides a convenient abstraction of BTCPayServer's [cryptographically-secure API](https://docs.btcpayserver.org/CustomIntegration/) and allows payment gateway developers to focus on payment flow/e-commerce integration rather than on the specific details of client-server interaction using the API.  This SDK optionally provides the flexibility for developers to have control over important details, including the handling of private keys needed for client-server communication.

It also implements BTCPayServer's remote client authentication and authorization strategy.  No private or shared-secret information is ever transmitted over the wire.

### Dependencies

You must have access to a BTCPayServer merchant account to use this SDK.  For testing purposes the [demo server](https://mainnet.demo.btcpayserver.org/) might be sufficient. If you plan to use BTCPayServer in production it is recommended to look for a 3rd party host or setup your own BTCPayServer instance.

### Handling your client private key

Each client paired with a BTCPayServer requires a ECDSA key.  This key provides the security mechanism for all client interaction with a BTCPayServer. The public key is used to derive the specific client identity that is displayed on your BTCPayServer dashboard.  The public key is also used for securely signing all API requests from the client.  See the [BTCPayServer docs](https://docs.btcpayserver.org/) for more information.

The private key should be stored in the client environment such that it cannot be compromised.  If your private key is compromised you should revoke the compromised client identity from the BTCPayServer and re-pair your client, see the [API tokens](https://docs.btcpayserver.org/CustomIntegration/) for more information.

To generate the configuration file required to load the SDK:

The [BTCPayServer Config Generator](https://github.com/btcpayserver/btcpayserver-php-client/blob/master/examples/ConfigGenerator.php) helps to generate the private key, as well as a environment file formatted in JSON or YML which contains all configuration requirements, that should be stored in the client local file system. It is not recommended to transmit the private key over any public unsecured networks.

The comments in this script will assist you to create the environment file which you will be able to modify it later.

Once the Config Generator has run and generated the Json/Yml correctly, read the console output and follow the instructions in order to pair your new tokens.

The environment file can be either generated by the script mentioned before or created manually by copying the following Json or YML structure:

JSON:
```json
{
  "BitPayConfiguration": {
    "Environment": "",
    "EnvConfig": {
      "Test": {
        "Url": "",
        "PrivateKeyPath": "",
        "PrivateKeySecret": "",
        "ApiTokens": {
          "merchant": "",
          "payroll": ""
        }
      },
      "Prod": {
        "Url": "",
        "PrivateKeyPath": "",
        "PrivateKeySecret": "",
        "ApiTokens": {
          "merchant": "",
          "payroll": ""
        }
      }
    }
  }
}
```
##
YML:
```yml
BitPayConfiguration:
  Environment: null
  EnvConfig:
    Test:
      Url: null
      PrivateKeyPath: null
      PrivateKeySecret: null
      ApiTokens:
        merchant: null
        payroll: null
    Prod:
      Url: null
      PrivateKeyPath: null
      ApiTokens:
        merchant: null
        payroll: null
```

# Installation

## Composer

### Install Composer

```bash
curl -sS https://getcomposer.org/installer | php
```

### Install via composer by hand

Add to your composer.json file by hand.

```javascript
{
    ...
    "require": {
        ...
        "btcpayserver/btcpayserver-php-client": "^2.0.0"
    }
    ...
}
```

Once you have added this, just run:

```bash
php composer.phar update btcpayserver/btcpayserver-php-client
```

### Install using composer

```bash
php composer.phar require btcpayserver/btcpayserver-php-client:~2.0
```

### Initializing your BtcPay client

Once you have the environment file (JSON or YML previously generated) you can initialize the client on two different ways:

```php
// Provide the full path to the env file which you have previously stored securely.

$bitpay = BtcPaySDK\Client::create()->withFile([FULL_PATH_TO_THE_CONFIG_FILE]);
```

```php
// Initialize with separate variables 
// and Private Key stored in file.

$bitpay = BtcPaySDK\Client::create()->withData(
    BtcPaySDK\Env.Test,
    "[FULL_PATH_TO_THE_PRIVATE_KEY]",
    new BtcPaySDK\Tokens(
        "7UeQtMcsHamehE4gDZojUQbNRbSuSdggbH17sawtobGJ", //merchant
        "5j48K7pUrX5k59DLhRVYkCupgw2CtoEt8DBFrHo2vW47" //payroll
    ),
    "YourMasterPassword" //used to decrypt your private key, if encrypted
);
```
```php
// Initialize with separate variables 
// and Private Key as HEX string.

$bitpay = BtcPaySDK\Client::create()->withData(
    BtcPaySDK\Env.Test,
    "[PRIVATE_KEY_AS_HEX_STRING]",
    new BtcPaySDK\Tokens(
        "7UeQtMcsHamehE4gDZojUQbNRbSuSdggbH17sawtobGJ", //merchant
        "5j48K7pUrX5k59DLhRVYkCupgw2CtoEt8DBFrHo2vW47" //payroll
    )
);
```
##
### Create an invoice

```php
$invoice = $bitpay->createInvoice(new Invoice(50.0, "USD"));

$invoiceUrl = $invoice->getURL();

$status = $invoice->getStatus();
```

### Retrieve an invoice

```php
$invoice = $bitpay->getInvoice($invoice->getId());
```

### Get exchange Rates

You can retrieve BTCPayServer's exchange rates:

```php
$rates = $bitpay->getRates();

$rate = $rates->getRate(Currency::USD); //Always use the included Currency model to avoid typos

$rates->update();
```

See also the test package for more examples of API calls.

